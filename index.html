const planData = state.planData || [];<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Planner</title>
  <!-- Test image in head to verify loading -->
  <script>
    // Test if we can load external images
    const testImg = new Image();
    testImg.onload = () => console.log('‚úÖ External images CAN load in this environment');
    testImg.onerror = () => console.error('‚ùå External images CANNOT load in this environment');
    testImg.src = 'https://picsum.photos/50/50';
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .button-hover {
      transition: opacity 0.2s;
    }

    .button-hover:hover {
      opacity: 0.8;
    }

    .card-hover {
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .app-title {
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .loading-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @view-transition {
      navigation: auto;
    }

    /* Default styles - Mobile first */
    .mobile-filters {
      display: block;
    }

    .desktop-sidebar {
      display: none;
    }

    .recipe-card-desktop {
      display: none;
    }

    .recipe-list-mobile {
      display: block;
    }

    .mobile-list-item {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      cursor: pointer;
    }

    .mobile-list-item:last-child {
      border-bottom: none;
    }

    .mobile-list-item img {
      width: 60px;
      height: 60px;
      flex-shrink: 0;
      border-radius: 8px;
      object-fit: cover;
    }

    .mobile-list-content {
      flex: 1;
      min-width: 0;
    }

    /* Desktop overrides - ONLY on large screens */
    @media (min-width: 1025px) {
      .mobile-filters {
        display: none;
      }

      .desktop-sidebar {
        display: grid;
      }

      .recipe-card-desktop {
        display: grid;
      }

      .recipe-list-mobile {
        display: none;
      }

      .mobile-list-item {
        display: none;
      }
    }

    /* Mobile optimizations */
    @media (max-width: 1024px) {
      .mobile-stack {
        flex-direction: column;
      }
      
      .mobile-full {
        width: 100%;
      }

      /* Hide sidebar on mobile - show inline filters */
      .desktop-sidebar {
        display: none !important;
      }

      .mobile-filters {
        display: block !important;
      }

      /* Compact list view for mobile */
      .recipe-card-desktop {
        display: none !important;
      }

      .recipe-list-mobile {
        display: block !important;
      }

      .mobile-list-item {
        display: flex !important;
        flex-direction: row !important;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-bottom: 1px solid rgba(255,255,255,0.08);
      }

      .mobile-list-item:last-child {
        border-bottom: none;
      }

      .mobile-list-item img {
        width: 60px;
        height: 60px;
        flex-shrink: 0;
        border-radius: 8px;
        object-fit: cover;
      }

      .mobile-list-content {
        flex: 1;
        min-width: 0;
      }

      /* Reduce header size on mobile */
      .page-header h2 {
        font-size: 1.5rem !important;
      }

      .page-header p {
        font-size: 0.75rem !important;
      }

      /* Stack buttons vertically on mobile */
      .header-buttons {
        flex-direction: column;
        width: 100%;
        gap: 8px;
      }

      .header-buttons button {
        width: 100%;
        font-size: 14px !important;
        padding: 10px 16px !important;
      }

      /* Compact padding */
      .page-container {
        padding: 12px !important;
      }
    }

    /* Accordion styling */
    details summary {
      transition: all 0.2s;
    }

    details[open] summary span:first-of-type {
      transform: rotate(90deg);
      display: inline-block;
    }

    details summary::-webkit-details-marker {
      display: none;
    }

    /* Toast notifications */
    .toast {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Keyboard navigation hint */
    .kbd {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 3px;
      padding: 2px 6px;
      font-family: monospace;
      font-size: 0.85em;
    }
  </style>
</head>
<body class="h-full">
  <div id="app" class="h-full w-full overflow-auto"></div>

  <!-- Export/Import Modal -->
  <div id="modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div id="modal-content" class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-auto"></div>
  </div>

  <script>
    // ===== CONFIG & STATE =====
    const CONFIG = {
      background_color: "#0f0f23",
      surface_color: "#1a1a2e",
      text_color: "#e4e4e7",
      primary_action_color: "#667eea",
      secondary_action_color: "#764ba2",
      accent_color: "#f59e0b",
      font_family: "system-ui, -apple-system, sans-serif",
      font_size: 16,
      app_title: "Meal Planner",
      recipes_label: "My Recipes",
      weekly_plan_label: "Weekly Plan",
      grocery_list_label: "Grocery List"
    };

    const ING_GROUPS = ['Produce', 'Beef', 'Poultry', 'Pork', 'Lamb & Goat', 'Seafood', 'Dairy & Eggs', 'Grains & Pasta', 'Pantry', 'Spices & Seasonings', 'Prepared', 'Other'];
    const MEAL_CATEGORIES = ['Breakfast', 'Lunch', 'Dinner', 'Appetizer'];
    const SOURCE_TYPES = ['user', 'chefiq'];
    const STORAGE_KEY = 'meal_planner_data_v1';

    // State

    const state = {
  recipes: [],
  planData: [],
  mealSelections: [],
  groceryItems: [],
  currentView: 'home',
  recipeForm: null,
  selectedDayForRecipe: null,
  selectedMealForRecipe: null,
  selectedCategory: 'All',
  searchTerm: '',
  filterFavorites: false,
  filterUserCreated: false,  // ‚Üê ADD THIS LINE
  filterSourceType: 'all',
  filterIngredientGroup: 'all',
  showDrafts: false,
  selectedGroceryDate: null,
  selectedGroceryMeal: null,
  selectedGroceryRecipeId: null,
currentWeekStartDate: new Date().toISOString().split('T')[0],
      isLoading: false,
  selectedRecipeViewId: null,
  viewingFromPlan: null,
};

    // ===== STORAGE SDK =====
    const storage = {
      load() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch {
          return [];
        }
      },

      save(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      },

      _data: [],
      _handler: null,

      async init(handler) {
        this._data = this.load();
        this._handler = handler;
        handler.onDataChanged(this._data);
        return { isOk: true };
      },

      async create(item) {
        this._data.push(item);
        this.save(this._data);
        this._handler?.onDataChanged(this._data);
        return { isOk: true };
      },

      async update(item) {
        const idx = this._data.findIndex(d => d.id === item.id);
        if (idx !== -1) this._data[idx] = item;
        this.save(this._data);
        this._handler?.onDataChanged(this._data);
        return { isOk: true };
      },

      async delete(item) {
        this._data = this._data.filter(d => d.id !== item.id);
        this.save(this._data);
        this._handler?.onDataChanged(this._data);
        return { isOk: true };
      }
    };

    // ===== UTILITIES =====
    function esc(s) {
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

   function getWeekDates(startDate) {
  const dates = [];
  const start = new Date(startDate);
  
  // Start with the given date and get the next 7 days
  for (let i = 0; i < 7; i++) {
    const date = new Date(start);
    date.setDate(start.getDate() + i);
    dates.push(date.toISOString().split('T')[0]);
  }
  return dates;
}

    function formatDateDisplay(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    function normalizeIngredient(name) {
      return name.toLowerCase().trim().replace(/[^a-z0-9]/g, '');
    }

    function showError(message) {
      showToast(message, 'error');
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = 'toast fixed top-4 right-4 px-4 py-3 rounded shadow-lg z-50';
      
      if (type === 'error') {
        toast.style.background = '#dc2626';
        toast.style.color = 'white';
      } else if (type === 'success') {
        toast.style.background = '#16a34a';
        toast.style.color = 'white';
      } else {
        toast.style.background = CONFIG.primary_action_color;
        toast.style.color = CONFIG.text_color;
      }
      
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ===== MODAL UTILITIES =====
    function openModal(content) {
      const modal = document.getElementById('modal');
      const modalContent = document.getElementById('modal-content');
      modalContent.innerHTML = content;
      modal.style.display = 'flex';
    }

    function closeModal() {
      const modal = document.getElementById('modal');
      modal.style.display = 'none';
    }

    // Click outside to close
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('modal');
      if (e.target === modal) {
        closeModal();
      }
    });

    // ===== EXPORT/IMPORT =====
    function exportData() {
      const data = storage.load();
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `meal-planner-backup-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      showToast('Data exported successfully!', 'success');
    }

    function showImportModal() {
      openModal(`
        <div style="color: #1a1a2e;">
          <h2 class="text-2xl font-bold mb-4">Import Data</h2>
          <p class="mb-4">Upload a previously exported JSON file to restore your data.</p>
          <p class="mb-4 text-red-600 font-semibold">‚ö†Ô∏è Warning: This will replace all current data!</p>
          
          <input type="file" id="importFile" accept=".json" class="mb-4 w-full p-2 border rounded">
          
          <div class="flex gap-2 justify-end">
            <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
              Cancel
            </button>
            <button onclick="importData()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
              Import
            </button>
          </div>
        </div>
      `);
    }

    function importData() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showError('Please select a file to import');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (!Array.isArray(data)) {
            showError('Invalid data format');
            return;
          }

          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          storage._data = data;
          dataHandler.onDataChanged(data);
          
          closeModal();
          showToast('Data imported successfully!', 'success');
          navigateTo('home');
        } catch (err) {
          showError('Failed to import data: Invalid JSON file');
          console.error(err);
        }
      };
      
      reader.readAsText(file);
    }

    function showClearDataModal() {
      openModal(`
        <div style="color: #1a1a2e;">
          <h2 class="text-2xl font-bold mb-4">Clear All Data</h2>
          <p class="mb-4 text-red-600 font-semibold">‚ö†Ô∏è Warning: This will permanently delete all your recipes, meal plans, and grocery lists!</p>
          <p class="mb-4">This action cannot be undone. Consider exporting your data first.</p>
          
          <div class="flex gap-2 justify-end">
            <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
              Cancel
            </button>
            <button onclick="clearAllData()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
              Clear All Data
            </button>
          </div>
        </div>
      `);
    }

    function clearAllData() {
      localStorage.removeItem(STORAGE_KEY);
      storage._data = [];
      dataHandler.onDataChanged([]);
      closeModal();
      showToast('All data cleared', 'success');
      navigateTo('home');
    }

    // ===== KEYBOARD SHORTCUTS =====
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Ignore if typing in input/textarea
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        // Ctrl/Cmd + E: Export data
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
          e.preventDefault();
          exportData();
        }

        // Ctrl/Cmd + I: Import data
        if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
          e.preventDefault();
          showImportModal();
        }

        // Escape: Close modal or go back
        if (e.key === 'Escape') {
          const modal = document.getElementById('modal');
          if (modal.style.display === 'flex') {
            closeModal();
          } else if (state.currentView !== 'home') {
            navigateTo('home');
          }
        }

        // H: Go home
        if (e.key === 'h' && state.currentView !== 'home') {
          navigateTo('home');
        }

        // R: Go to recipes
        if (e.key === 'r' && state.currentView !== 'recipes') {
          navigateTo('recipes');
        }

        // W: Go to weekly plan
        if (e.key === 'w' && state.currentView !== 'weekly-plan') {
          navigateTo('weekly-plan');
        }

        // G: Go to grocery list
        if (e.key === 'g' && state.currentView !== 'grocery-list') {
          navigateTo('grocery-list');
        }

        // N: New recipe (when on recipes page)
        if (e.key === 'n' && state.currentView === 'recipes') {
          openNewRecipe();
        }

        // Arrow keys for week navigation
        if (state.currentView === 'weekly-plan') {
          if (e.key === 'ArrowLeft') {
            changeWeek(-1);
          } else if (e.key === 'ArrowRight') {
            changeWeek(1);
          }
        }
      });
    }

    // ===== RECIPE HELPERS =====
    function getRecipeById(id) {
      return state.recipes.find(r => r.__backendId === id || r.id === id);
    }

    function recipeThumb(r) {
      const u = (r?.image_url || '').trim();
      if (!u) return '';
      
      // Handle both http and https
      if (u.startsWith('http://') || u.startsWith('https://') || u.startsWith('data:')) {
        return u;
      }
      
      // If no protocol, assume https
      return 'https://' + u;
    }

    function recipeIngList(r) {
      if (!r) return [];
      if (Array.isArray(r.ingredientsRows) && r.ingredientsRows.length) {
        return r.ingredientsRows
          .map(x => ({
            qty: (x.qty || '').trim(),
            unit: (x.unit || '').trim(),
            name: (x.name || '').trim(),
            group: x.group || 'Other'
          }))
          .filter(x => x.name);
      }
      return [];
    }

    function newRecipeDraft() {
      return {
        type: 'recipe',
        title: '',
        category: 'Breakfast',
        recipe_url: '',
        image_url: '',
        tags: '',
        notes: '',
        instructions: '',
        ingredientsRows: [{ qty: '', unit: '', name: '', group: 'Produce' }],
        sourceType: 'chefiq',
        isDraft: false
      };
    }

    function ensureRecipeForm() {
      if (!state.recipeForm) state.recipeForm = newRecipeDraft();
      if (!Array.isArray(state.recipeForm.ingredientsRows)) state.recipeForm.ingredientsRows = [];
      if (state.recipeForm.ingredientsRows.length === 0) {
        state.recipeForm.ingredientsRows.push({ qty: '', unit: '', name: '', group: 'Produce' });
      }
    }

    // ===== RECIPE ACTIONS =====
    function setRecipeField(field, value) {
      ensureRecipeForm();
      state.recipeForm[field] = value;
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showError('Image size must be less than 5MB');
        event.target.value = '';
        return;
      }

      // Check file type
      if (!file.type.startsWith('image/')) {
        showError('Please select an image file');
        event.target.value = '';
        return;
      }

      // Convert to base64
      const reader = new FileReader();
      reader.onload = (e) => {
        setRecipeField('image_url', e.target.result);
        render();
        showToast('Image uploaded successfully!', 'success');
      };
      reader.onerror = () => {
        showError('Failed to read image file');
        event.target.value = '';
      };
      reader.readAsDataURL(file);
    }

    function removeImage() {
      setRecipeField('image_url', '');
      // Clear file input if exists
      const fileInput = document.getElementById('imageUploadInput');
      if (fileInput) fileInput.value = '';
      render();
    }

    function addIngRow() {
      ensureRecipeForm();
      state.recipeForm.ingredientsRows.push({ qty: '', unit: '', name: '', group: 'Produce' });
      render();
    }

    function showBulkImportModal() {
      openModal(`
        <div style="color: #1a1a2e;">
          <h2 class="text-2xl font-bold mb-4">üìã Bulk Import Ingredients</h2>
          <p class="mb-4">Paste your ingredient list below. The app will automatically parse quantities, units, and names.</p>
          
          <div class="mb-4 p-3 bg-blue-50 rounded">
            <p class="font-semibold mb-2">Supported Formats:</p>
            <ul class="text-sm space-y-1">
              <li>‚Ä¢ "1 lb Boneless lamb stew meat"</li>
              <li>‚Ä¢ "2 Tbsp Finely chopped fresh ginger"</li>
              <li>‚Ä¢ "1/2 tsp Cayenne"</li>
              <li>‚Ä¢ "1 14.5-oz can Crushed tomatoes"</li>
              <li>‚Ä¢ "Chopped fresh cilantro (Optional)"</li>
            </ul>
          </div>

          <textarea id="bulkIngredientInput" 
            class="w-full p-3 border rounded" 
            rows="12"
            placeholder="Paste ingredients here...
1 lb Boneless lamb stew meat
1 tsp Kosher salt
1 tsp Ground coriander
..."
            style="font-family: monospace; font-size: 14px;"></textarea>
          
          <div class="flex gap-2 justify-end mt-4">
            <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
              Cancel
            </button>
            <button onclick="processBulkIngredients()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
              Import Ingredients
            </button>
          </div>
        </div>
      `);
    }

    function processBulkIngredients() {
      const textarea = document.getElementById('bulkIngredientInput');
      const text = textarea.value.trim();
      
      if (!text) {
        showError('Please paste some ingredients first');
        return;
      }

      const lines = text.split('\n').filter(line => line.trim());
      const parsedIngredients = [];

      lines.forEach(line => {
        const parsed = parseIngredientLine(line);
        if (parsed.name) {
          parsedIngredients.push(parsed);
        }
      });

      if (parsedIngredients.length === 0) {
        showError('No valid ingredients found');
        return;
      }

      // Add to recipe form
      ensureRecipeForm();
      state.recipeForm.ingredientsRows = parsedIngredients;
      
      closeModal();
      render();
      showToast(`Imported ${parsedIngredients.length} ingredients!`, 'success');
    }

    function parseIngredientLine(line) {
      line = line.trim();
      
      // Remove leading bullet points or dashes
      line = line.replace(/^[‚Ä¢\-\*]\s*/, '');
      
      // Common units to look for
      const units = [
        'lb', 'lbs', 'pound', 'pounds',
        'oz', 'ounce', 'ounces',
        'g', 'gram', 'grams',
        'kg', 'kilogram', 'kilograms',
        'tsp', 'teaspoon', 'teaspoons',
        'tbsp', 'tablespoon', 'tablespoons',
        'cup', 'cups',
        'ml', 'milliliter', 'milliliters',
        'l', 'liter', 'liters',
        'can', 'cans',
        'piece', 'pieces',
        'slice', 'slices',
        'clove', 'cloves',
        'inch', 'inches'
      ];

      // Try to match: quantity unit name
      // Examples: "1 lb Boneless lamb", "2 Tbsp Fresh ginger", "1/2 tsp Cayenne"
      const regex = /^([\d\/\.\s]+)?\s*([a-zA-Z\-]+)?\s*(.+)$/;
      const match = line.match(regex);

      if (!match) {
        return { qty: '', unit: '', name: line, group: 'Other' };
      }

      let [, quantity, possibleUnit, rest] = match;
      quantity = (quantity || '').trim();
      possibleUnit = (possibleUnit || '').toLowerCase().trim();
      rest = (rest || '').trim();

      let unit = '';
      let name = rest;

      // Check if possibleUnit is actually a unit
      if (possibleUnit && units.includes(possibleUnit)) {
        unit = possibleUnit;
      } else if (possibleUnit) {
        // It's not a unit, it's part of the name
        name = possibleUnit + ' ' + rest;
      }

      // Clean up name - remove parenthetical notes like (Optional), (from a 2-inch piece)
      const cleanName = name.replace(/\([^)]*\)$/g, '').trim();
      
      // Remove trailing commas and clean up
      const finalName = cleanName.replace(/,\s*$/, '').trim();

      // Auto-detect ingredient group
      const group = detectIngredientGroup(finalName);

      return {
        qty: quantity,
        unit: unit,
        name: finalName,
        group: group
      };
    }

    function detectIngredientGroup(name) {
      const nameLower = name.toLowerCase();
      
      // Comprehensive keyword matching with priority order (most specific first)
      
      // Spices & Seasonings (check first - very specific)
      if (nameLower.match(/\b(salt|pepper|spice|cumin|coriander|turmeric|cayenne|paprika|cinnamon|nutmeg|clove|cardamom|bay leaf|bay leaves|thyme|rosemary|oregano|basil|sage|dill|tarragon|chive|mint|parsley|cilantro|masala|garam masala|curry powder|chili powder|red pepper flakes|garlic powder|onion powder|ginger powder|fennel seed|caraway|anise|saffron|vanilla|extract|seasoning|dried herbs?|ground spices?|whole spices?|peppercorn|kosher salt|sea salt|himalayan salt|black pepper|white pepper|cayenne pepper|chili flakes?|italian seasoning|herbs? de provence|five spice|chinese five spice|cajun|creole|taco seasoning|ranch|everything bagel)\b/)) {
        return 'Spices & Seasonings';
      }
      
      // Beef (specific cuts and types)
      if (nameLower.match(/\b(beef|steak|ground beef|chuck|brisket|ribeye|rib eye|sirloin|tenderloin|filet mignon|t-bone|porterhouse|new york strip|flank|skirt|hanger|tri-tip|short rib|oxtail|beef shank|stew meat|beef roast|prime rib|london broil|beef patty|beef patties|ground chuck|beef mince|corned beef|pastrami|beef jerky)\b/)) {
        return 'Beef';
      }
      
      // Poultry (all types)
      if (nameLower.match(/\b(chicken|turkey|duck|quail|cornish hen|poultry|breast|thigh|wing|drumstick|chicken breast|chicken thigh|turkey breast|ground chicken|ground turkey|chicken tenders|chicken cutlet|whole chicken|rotisserie chicken|chicken quarters?|duck breast|duck leg)\b/)) {
        return 'Poultry';
      }
      
      // Pork (all cuts and products)
      if (nameLower.match(/\b(pork|bacon|ham|sausage|prosciutto|pancetta|chorizo|salami|pepperoni|pork chop|pork loin|pork shoulder|pork belly|ground pork|pork ribs?|baby back ribs?|spare ribs?|pork tenderloin|pulled pork|pork roast|canadian bacon|breakfast sausage|italian sausage|bratwurst|hot dogs?|frankfurter|kielbasa|andouille)\b/)) {
        return 'Pork';
      }
      
      // Lamb & Goat (all cuts)
      if (nameLower.match(/\b(lamb|goat|mutton|lamb chop|lamb shank|lamb shoulder|leg of lamb|rack of lamb|ground lamb|lamb stew|lamb loin|goat meat|lamb ribs?)\b/)) {
        return 'Lamb & Goat';
      }
      
      // Seafood (comprehensive)
      if (nameLower.match(/\b(fish|salmon|tuna|shrimp|prawns?|crab|lobster|seafood|cod|tilapia|halibut|mahi|mahi-mahi|scallops?|clams?|mussels?|oysters?|anchovies|anchovy|sardines?|trout|bass|snapper|grouper|catfish|sole|flounder|haddock|swordfish|mackerel|herring|sea bass|seabass|shellfish|calamari|squid|octopus|crayfish|crawfish|caviar|roe|fish fillet|fish steak|smoked salmon|canned tuna|canned salmon|imitation crab)\b/)) {
        return 'Seafood';
      }
      
      // Dairy & Eggs (all dairy products)
      if (nameLower.match(/\b(milk|cream|cheese|butter|yogurt|egg|cheddar|mozzarella|parmesan|parmigiano|pecorino|feta|ricotta|cottage cheese|cream cheese|sour cream|heavy cream|whipping cream|half and half|buttermilk|whole milk|skim milk|2% milk|almond milk|oat milk|coconut milk|evaporated milk|condensed milk|powdered milk|goat cheese|chevre|brie|camembert|gouda|swiss|provolone|monterey jack|pepper jack|blue cheese|gorgonzola|mascarpone|burrata|ghee|clarified butter|unsalted butter|salted butter|margarine|eggs?|egg whites?|egg yolks?|quail eggs?|whey|greek yogurt|plain yogurt|kefir|cr√®me fraiche|clotted cream)\b/)) {
        return 'Dairy & Eggs';
      }
      
      // Grains & Pasta (all types)
      if (nameLower.match(/\b(rice|pasta|noodles?|spaghetti|penne|rigatoni|linguine|fettuccine|angel hair|macaroni|lasagna|ravioli|tortellini|gnocchi|orzo|couscous|quinoa|bulgur|farro|barley|oats?|oatmeal|wheat|grain|bread|baguette|sourdough|whole wheat|white bread|rye bread|pita|naan|tortilla|flour tortilla|corn tortilla|wrap|bagel|english muffin|bun|roll|dinner roll|kaiser roll|ciabatta|focaccia|breadcrumb|panko|crouton|flour|all-purpose flour|bread flour|whole wheat flour|cornmeal|polenta|grits|cereal|granola|muesli|arborio rice|jasmine rice|basmati rice|brown rice|white rice|wild rice|rice noodle|ramen|udon|soba|pad thai noodle|lo mein|vermicelli|egg noodle|wheat noodle|glass noodle)\b/)) {
        return 'Grains & Pasta';
      }
      
      // Pantry (oils, sauces, condiments, canned goods)
      if (nameLower.match(/\b(oil|olive oil|vegetable oil|canola oil|coconut oil|sesame oil|peanut oil|avocado oil|grapeseed oil|sunflower oil|corn oil|cooking oil|spray oil|vinegar|balsamic|apple cider vinegar|white vinegar|red wine vinegar|rice vinegar|wine vinegar|sauce|soy sauce|tamari|fish sauce|worcestershire|oyster sauce|hoisin|teriyaki|hot sauce|tabasco|sriracha|chili sauce|BBQ sauce|barbecue sauce|ketchup|catsup|mustard|dijon|yellow mustard|whole grain mustard|mayo|mayonnaise|aioli|salsa|pico de gallo|marinara|tomato sauce|pasta sauce|alfredo|pesto|tahini|hummus|salad dressing|ranch|caesar|vinaigrette|honey|maple syrup|agave|molasses|corn syrup|simple syrup|sugar|brown sugar|white sugar|powdered sugar|confectioners sugar|granulated sugar|coconut sugar|stock|broth|chicken stock|beef stock|vegetable stock|bone broth|bouillon|demi-glace|wine|cooking wine|red wine|white wine|sherry|marsala|mirin|sake|beer|stout|ale|peanut butter|almond butter|cashew butter|sunflower butter|nutella|jam|jelly|preserves|marmalade|apple butter|relish|pickle|pickles|capers|olives|olive|kalamata|green olive|black olive|sun-dried tomato|tomato paste|canned tomato|diced tomato|crushed tomato|whole tomato|canned beans?|canned corn|canned peas|canned chickpea|canned tuna|canned salmon|canned soup|tomato soup|chicken noodle|condensed soup|bean|black beans?|kidney beans?|pinto beans?|cannellini|great northern|chickpea|garbanzo|lentils?|split peas?|dried beans?|baking powder|baking soda|yeast|active dry yeast|instant yeast|cornstarch|corn starch|potato starch|tapioca|arrowroot|gelatin|agar|pectin|cocoa powder|chocolate chips?|dark chocolate|milk chocolate|white chocolate|baking chocolate|vanilla extract|almond extract|food coloring|sprinkles)\b/)) {
        return 'Pantry';
      }
      
      // Produce (vegetables, fruits, fresh herbs - very comprehensive)
      if (nameLower.match(/\b(produce|vegetable|fruit|lettuce|spinach|kale|arugula|chard|collard|cabbage|bok choy|napa cabbage|brussels sprout|broccoli|cauliflower|romanesco|broccolini|asparagus|artichoke|carrot|celery|onion|red onion|yellow onion|white onion|sweet onion|vidalia|shallot|leek|scallion|green onion|spring onion|garlic|ginger|galangal|turmeric root|horseradish|radish|turnip|rutabaga|parsnip|beet|beetroot|potato|russet potato|yukon gold|red potato|sweet potato|yam|bell pepper|red pepper|green pepper|yellow pepper|orange pepper|jalape√±o|jalapeno|serrano|habanero|poblano|anaheim|chili pepper|thai chili|pepper|hot pepper|banana pepper|cherry pepper|pepperoncini|tomato|cherry tomato|grape tomato|roma tomato|beefsteak|heirloom tomato|tomatillo|cucumber|english cucumber|persian cucumber|zucchini|yellow squash|summer squash|butternut squash|acorn squash|spaghetti squash|pumpkin|winter squash|eggplant|aubergine|okra|green beans?|string beans?|snap peas?|snow peas?|sugar snap|edamame|corn|sweet corn|corn on the cob|baby corn|mushroom|button mushroom|cremini|portobello|shiitake|oyster mushroom|enoki|porcini|morel|chanterelle|fresh mushroom|cilantro|coriander leaves|parsley|fresh parsley|flat-leaf parsley|curly parsley|basil|fresh basil|thai basil|mint|fresh mint|dill|fresh dill|chives?|fresh chive|tarragon|fresh tarragon|sage|fresh sage|rosemary|fresh rosemary|thyme|fresh thyme|oregano|fresh oregano|bay leaf fresh|lemongrass|curry leaves?|kaffir lime|lime leaves?|watercress|microgreen|sprouts?|alfalfa sprout|bean sprout|mung bean|avocado|apple|gala|honeycrisp|granny smith|fuji|red delicious|golden delicious|banana|plantain|orange|mandarin|clementine|tangerine|blood orange|navel orange|grapefruit|lemon|meyer lemon|lime|key lime|pear|anjou|bartlett|bosc|asian pear|peach|nectarine|apricot|plum|cherry|rainier cherry|bing cherry|grape|red grape|green grape|seedless grape|berry|strawberry|blueberry|raspberry|blackberry|cranberry|gooseberry|currant|melon|watermelon|cantaloupe|honeydew|mango|papaya|pineapple|kiwi|star fruit|dragon fruit|passion fruit|fig|date|pomegranate|persimmon|guava|lychee|rambutan|coconut|fresh coconut|young coconut)\b/)) {
        return 'Produce';
      }
      
      // Prepared (frozen, canned, pre-made, packaged)
      if (nameLower.match(/\b(frozen|canned|prepared|ready|pre-cooked|precooked|instant|packaged|pre-made|premade|pre-cut|precut|store-bought|storebought|frozen vegetables?|frozen fruit|frozen dinner|frozen meal|frozen pizza|frozen fries|frozen french fries|frozen peas|frozen corn|frozen berries|frozen shrimp|frozen fish|ice cream|frozen yogurt|gelato|sorbet|sherbet|popsicle|frozen waffle|frozen pancake|frozen hash brown|tater tots?|TV dinner|microwave meal|instant noodle|instant rice|instant oatmeal|instant coffee|pre-washed|bagged salad|pre-shredded|shredded cheese|pre-sliced|deli meat|lunch meat|rotisserie|pre-cooked chicken|canned soup|canned chili|canned ravioli|frozen lasagna|frozen burrito|hot pocket|pizza roll|chicken nugget|fish stick|frozen vegetable mix|stir fry mix|ready-to-eat)\b/)) {
        return 'Prepared';
      }
      
      // Default to Other
      return 'Other';
    }

    function delIngRow(i) {
      ensureRecipeForm();
      state.recipeForm.ingredientsRows.splice(i, 1);
      if (state.recipeForm.ingredientsRows.length === 0) addIngRow();
      render();
    }

    function setIng(i, field, value) {
      ensureRecipeForm();
      state.recipeForm.ingredientsRows[i][field] = value;
    }

    function openNewRecipe() {
      state.recipeForm = newRecipeDraft();
      state.recipeForm.isDraft = false;
      state.currentView = 'recipe-edit';
      render();
    }

    function openNewDraft() {
      state.recipeForm = newRecipeDraft();
      state.recipeForm.isDraft = true;
      state.currentView = 'recipe-edit';
      render();
    }

    function openEditRecipe(recipeId) {
      const r = getRecipeById(recipeId);
      if (!r) return;

      const rows = Array.isArray(r.ingredientsRows) ? r.ingredientsRows : [];
      state.recipeForm = {
        ...newRecipeDraft(),
        ...r,
        ingredientsRows: rows.length ? rows : [{ qty: '', unit: '', name: '', group: 'Produce' }]
      };

      state.currentView = 'recipe-edit';
      render();
    }

    function closeRecipeEditor() {
      state.recipeForm = null;
      state.currentView = 'recipes';
      render();
    }

    function openRecipeView(id, fromPlan = null) {
      state.selectedRecipeViewId = id;
      state.viewingFromPlan = fromPlan; // {date, meal} or null
      state.currentView = 'recipe-view';
      render();
    }

    async function saveRecipeForm() {
      ensureRecipeForm();

      const title = (state.recipeForm.title || '').trim();
      const cat = (state.recipeForm.category || '').trim();
      const url = (state.recipeForm.recipe_url || '').trim();

      if (!title) return showError('Recipe Title is required.');
      if (!cat) return showError('Category is required.');
      if (!url) return showError('Recipe URL is required.');

      const rows = (state.recipeForm.ingredientsRows || [])
        .map(r => ({
          qty: (r.qty || '').trim(),
          unit: (r.unit || '').trim(),
          name: (r.name || '').trim(),
          group: r.group || 'Other'
        }))
        .filter(r => r.name);

      if (!rows.length) return showError('Add at least 1 ingredient.');

      const payload = {
        ...state.recipeForm,
        title,
        category: cat,
        recipe_url: url,
        image_url: (state.recipeForm.image_url || '').trim(),
        tags: (state.recipeForm.tags || '').trim(),
        notes: (state.recipeForm.notes || '').trim(),
        instructions: (state.recipeForm.instructions || '').trim(),
        ingredientsRows: rows,
        sourceType: state.recipeForm.sourceType || 'user',
        isDraft: state.recipeForm.isDraft || false
      };

      try {
        if (payload.id) {
          await storage.update(payload);
        } else {
          payload.id = `recipe_${Date.now()}_${Math.random().toString(36).slice(2)}`;
          await storage.create(payload);
        }
        showToast(payload.isDraft ? 'Draft saved!' : 'Recipe saved!', 'success');
        closeRecipeEditor();
      } catch (e) {
        console.error(e);
        showError('Failed to save recipe.');
      }
    }

    async function publishDraft(recipeId) {
      const recipe = getRecipeById(recipeId);
      if (!recipe) return;

      const updatedRecipe = { ...recipe, isDraft: false };
      
      try {
        await storage.update(updatedRecipe);
        showToast('Draft published!', 'success');
      } catch (e) {
        console.error(e);
        showError('Failed to publish draft.');
      }
    }

    async function deleteRecipe(recipe) {
      state.isLoading = true;
      render();

      const result = await storage.delete(recipe);
      state.isLoading = false;

      if (!result.isOk) {
        showError('Failed to delete recipe');
        render();
      }
    }

    async function toggleFavorite(recipeId) {
      const recipe = getRecipeById(recipeId);
      if (!recipe) return;

      state.isLoading = true;
      render();

      const updatedRecipe = { ...recipe, favorite: !recipe.favorite };
      const result = await storage.update(updatedRecipe);
      state.isLoading = false;

      if (!result.isOk) {
        showError('Failed to update favorite status');
        render();
      }
    }

    // ===== MEAL PLANNING =====
    async function savePlan(date, meal, recipeId) {
      const planId = `plan_${date}`;
      let plan = state.planData.find(p => p.date === date);

      state.isLoading = true;
      render();

      const mealKey = meal.toLowerCase();

      try {
        if (plan) {
          const updatedPlan = { ...plan, [mealKey]: recipeId };
          await storage.update(updatedPlan);
        } else {
          if (state.planData.length >= 999) {
            showError('Maximum limit of 999 plans reached');
            return;
          }
          const newPlan = {
            id: planId,
            date: date,
            breakfast: mealKey === 'breakfast' ? recipeId : null,
            lunch: mealKey === 'lunch' ? recipeId : null,
            dinner: mealKey === 'dinner' ? recipeId : null
          };
          await storage.create(newPlan);
        }
      } finally {
        state.isLoading = false;
        render();
      }
    }

    async function removeMealFromPlan(date, meal) {
      const plan = state.planData.find(p => p.date === date);
      if (!plan) return;

      state.isLoading = true;
      render();

      const mealKey = meal.toLowerCase();
      const updatedPlan = { ...plan, [mealKey]: null };
      const result = await storage.update(updatedPlan);
      state.isLoading = false;

      if (!result.isOk) {
        showError('Failed to remove meal');
        render();
      }
    }

   function openRecipePicker(date, meal) {
  state.selectedDayForRecipe = date;
  state.selectedMealForRecipe = meal;
  state.selectedCategory = 'All'; // Default to All when picking recipes
  render();  // ‚Üê Move render() before changing view
  state.currentView = 'recipe-picker';
}

    async function handleRecipePickerSelect(recipeId) {
      await savePlan(state.selectedDayForRecipe, state.selectedMealForRecipe, recipeId);
      state.selectedDayForRecipe = null;
      state.selectedMealForRecipe = null;
      state.currentView = 'weekly-plan';
      render();
    }

    function changeWeek(direction) {
      const date = new Date(state.currentWeekStartDate);
      date.setDate(date.getDate() + (direction * 7));
      state.currentWeekStartDate = date.toISOString().split('T')[0];
      render();
    }

    // ===== GROCERY LIST =====
    function getPlannedMealsForWeek(weekStart) {
      const weekDates = getWeekDates(weekStart);
      const meals = [];

      weekDates.forEach(date => {
        const plan = state.planData.find(p => p.date === date);
        if (plan) {
          ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
            if (plan[mealType]) {
              const recipe = getRecipeById(plan[mealType]);
              if (recipe) {
                meals.push({
                  date: date,
                  meal: mealType.charAt(0).toUpperCase() + mealType.slice(1),
                  recipeId: plan[mealType],
                  recipeTitle: recipe.title
                });
              }
            }
          });
        }
      });

      return meals;
    }

    function getGroceryList() {
      const aggregated = {};

      state.mealSelections.forEach(sel => {
        const parts = sel.id.split('_');
        const date = parts[1];
        const meal = parts[2];
        const plan = state.planData.find(p => p.date === date);
        if (!plan) return;

        const mealKey = (meal || '').toLowerCase();
        const recipeId = plan[mealKey];
        if (!recipeId) return;

        const r = getRecipeById(recipeId);
        if (!r) return;

        let keys = [];
        try {
          keys = JSON.parse(sel.includedIngredientKeys || '[]');
        } catch (e) {
          keys = [];
        }

        recipeIngList(r).forEach(ing => {
          const k = normalizeIngredient(ing.name);
          if (!keys.includes(k)) return;

          if (!aggregated[k]) {
            aggregated[k] = {
              name: ing.name,
              quantity: ing.qty || '',
              unit: ing.unit || '',
              checked: false
            };
          }
        });
      });

      Object.keys(aggregated).forEach(k => {
        const gi = state.groceryItems.find(x => x.ingredientKey === k);
        aggregated[k].checked = gi ? !!gi.checked : false;
      });

      return Object.values(aggregated);
    }

    function openGroceryIngredientPicker(date, meal, recipeId) {
      state.selectedGroceryDate = date;
      state.selectedGroceryMeal = meal;
      state.selectedGroceryRecipeId = recipeId;

      (async () => {
        const selId = `mealSel_${date}_${meal}`;
        let sel = state.mealSelections.find(s => s.id === selId);
        if (!sel) {
          const r = getRecipeById(recipeId);
          const keys = recipeIngList(r).map(x => normalizeIngredient(x.name));
          sel = {
            id: selId,
            mealDate: date,
            meal: meal,
            includedIngredientKeys: JSON.stringify(keys)
          };
          await storage.create(sel);
          state.mealSelections.push(sel);
        }
        state.currentView = 'grocery-ingredients';
        render();
      })();
    }

    async function toggleMealIngredient(ingredientKey) {
      const selId = `mealSel_${state.selectedGroceryDate}_${state.selectedGroceryMeal}`;
      let sel = state.mealSelections.find(s => s.id === selId);

      let includedKeys = [];
      if (sel) {
        try {
          includedKeys = JSON.parse(sel.includedIngredientKeys || '[]');
        } catch (e) {
          includedKeys = [];
        }
      }

      const index = includedKeys.indexOf(ingredientKey);
      if (index > -1) {
        includedKeys.splice(index, 1);
      } else {
        includedKeys.push(ingredientKey);
      }

      state.isLoading = true;
      render();

      try {
        if (sel) {
          const updatedSel = { ...sel, includedIngredientKeys: JSON.stringify(includedKeys) };
          await storage.update(updatedSel);
        } else {
          if (state.mealSelections.length >= 999) {
            showError('Maximum limit reached');
            return;
          }
          const newSel = {
            id: selId,
            mealDate: state.selectedGroceryDate,
            meal: state.selectedGroceryMeal,
            includedIngredientKeys: JSON.stringify(includedKeys)
          };
          await storage.create(newSel);
        }
      } finally {
        state.isLoading = false;
        render();
      }
    }

    async function toggleGroceryItem(ingredientKey) {
      let item = state.groceryItems.find(gi => gi.ingredientKey === ingredientKey);

      state.isLoading = true;
      render();

      try {
        if (item) {
          const updatedItem = { ...item, checked: !item.checked };
          await storage.update(updatedItem);
        } else {
          if (state.groceryItems.length >= 999) {
            showError('Maximum limit reached');
            return;
          }
          const newItem = {
            id: `grocery_${Date.now()}_${ingredientKey}`,
            ingredientKey: ingredientKey,
            checked: true
          };
          await storage.create(newItem);
        }
      } finally {
        state.isLoading = false;
        render();
      }
    }

    // ===== DATA HANDLER =====
    const dataHandler = {
      onDataChanged(data) {
        state.recipes = data.filter(d => d.id && d.id.startsWith('recipe_'));
        state.planData = data.filter(d => d.date && d.id && d.id.startsWith('plan_'));
        state.mealSelections = data.filter(d => d.id && d.id.startsWith('mealSel_'));
        state.groceryItems = data.filter(d => d.ingredientKey);
        render();
      }
    };

    // ===== NAVIGATION =====
    function navigateTo(view) {
      state.currentView = view;
      render();
    }

    // ===== RENDER FUNCTIONS =====
    function renderNav() {
      if (state.currentView === 'home') return '';

      return `
        <nav style="background: ${CONFIG.surface_color}; box-shadow: 0 2px 8px rgba(0,0,0,0.2);" class="p-4 mb-0 sticky top-0 z-50">
          <div class="max-w-7xl mx-auto flex items-center justify-between mobile-stack gap-4">
            <button type="button" onclick="navigateTo('home')"
                    style="color: ${CONFIG.text_color}; font-size: ${CONFIG.font_size * 1.3}px; font-family: ${CONFIG.font_family};"
                    class="font-bold button-hover flex items-center gap-2">
              <span style="font-size: 1.5rem;">üçΩÔ∏è</span>
              <span class="app-title">${CONFIG.app_title}</span>
            </button>
            <div class="flex gap-3 flex-wrap items-center">
              <button type="button" onclick="navigateTo('recipes')"
                      style="color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}; font-size: ${CONFIG.font_size}px;"
                      class="button-hover px-3 py-2 rounded-lg ${state.currentView.includes('recipe') ? 'glass' : ''}">
                üìö ${CONFIG.recipes_label}
              </button>
              <button type="button" onclick="navigateTo('weekly-plan')"
                      style="color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}; font-size: ${CONFIG.font_size}px;"
                      class="button-hover px-3 py-2 rounded-lg ${state.currentView === 'weekly-plan' ? 'glass' : ''}">
                üìÖ ${CONFIG.weekly_plan_label}
              </button>
              <button type="button" onclick="navigateTo('grocery-list')"
                      style="color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}; font-size: ${CONFIG.font_size}px;"
                      class="button-hover px-3 py-2 rounded-lg ${state.currentView.includes('grocery') ? 'glass' : ''}">
                üõí ${CONFIG.grocery_list_label}
              </button>
              <button type="button" onclick="showSettingsMenu()"
                      style="color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}; font-size: ${CONFIG.font_size * 1.3}px;"
                      class="button-hover p-2 rounded-lg hover:glass"
                      title="Settings & Export/Import">
                ‚öôÔ∏è
              </button>
            </div>
          </div>
        </nav>
      `;
    }

    function showSettingsMenu() {
      openModal(`
        <div style="color: #1a1a2e;">
          <h2 class="text-2xl font-bold mb-4">Settings & Data Management</h2>
          
          <div class="space-y-3">
            <button onclick="exportData(); closeModal();" 
                    class="w-full p-4 bg-blue-100 hover:bg-blue-200 rounded text-left">
              <div class="font-semibold text-lg">üì• Export Data</div>
              <div class="text-sm text-gray-600">Download a backup of all your data</div>
              <div class="text-xs text-gray-500 mt-1">Keyboard: <span class="kbd">Ctrl+E</span></div>
            </button>

            <button onclick="closeModal(); showImportModal();" 
                    class="w-full p-4 bg-green-100 hover:bg-green-200 rounded text-left">
              <div class="font-semibold text-lg">üì§ Import Data</div>
              <div class="text-sm text-gray-600">Restore from a backup file</div>
              <div class="text-xs text-gray-500 mt-1">Keyboard: <span class="kbd">Ctrl+I</span></div>
            </button>

            <button onclick="closeModal(); showKeyboardShortcuts();" 
                    class="w-full p-4 bg-purple-100 hover:bg-purple-200 rounded text-left">
              <div class="font-semibold text-lg">‚å®Ô∏è Keyboard Shortcuts</div>
              <div class="text-sm text-gray-600">View all available shortcuts</div>
            </button>

            <button onclick="closeModal(); showClearDataModal();" 
                    class="w-full p-4 bg-red-100 hover:bg-red-200 rounded text-left">
              <div class="font-semibold text-lg text-red-700">üóëÔ∏è Clear All Data</div>
              <div class="text-sm text-red-600">Permanently delete everything</div>
            </button>
          </div>

          <div class="mt-6 p-4 bg-gray-100 rounded">
            <div class="text-sm text-gray-700">
              <div class="font-semibold mb-2">üìä Current Data:</div>
              <div>Recipes: ${state.recipes.length}</div>
              <div>Meal Plans: ${state.planData.length}</div>
              <div>Grocery Items: ${state.groceryItems.length}</div>
            </div>
          </div>

          <div class="flex gap-2 justify-end mt-6">
            <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
              Close
            </button>
          </div>
        </div>
      `);
    }

    function showKeyboardShortcuts() {
      openModal(`
        <div style="color: #1a1a2e;">
          <h2 class="text-2xl font-bold mb-4">‚å®Ô∏è Keyboard Shortcuts</h2>
          
          <div class="space-y-4">
            <div>
              <h3 class="font-semibold text-lg mb-2">Navigation</h3>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between"><span>Go Home</span><span class="kbd">H</span></div>
                <div class="flex justify-between"><span>Go to Recipes</span><span class="kbd">R</span></div>
                <div class="flex justify-between"><span>Go to Weekly Plan</span><span class="kbd">W</span></div>
                <div class="flex justify-between"><span>Go to Grocery List</span><span class="kbd">G</span></div>
                <div class="flex justify-between"><span>Go Back / Close</span><span class="kbd">Esc</span></div>
              </div>
            </div>

            <div>
              <h3 class="font-semibold text-lg mb-2">Actions</h3>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between"><span>New Recipe (on Recipes page)</span><span class="kbd">N</span></div>
                <div class="flex justify-between"><span>Export Data</span><span class="kbd">Ctrl+E</span></div>
                <div class="flex justify-between"><span>Import Data</span><span class="kbd">Ctrl+I</span></div>
              </div>
            </div>

            <div>
              <h3 class="font-semibold text-lg mb-2">Weekly Plan</h3>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between"><span>Previous Week</span><span class="kbd">‚Üê</span></div>
                <div class="flex justify-between"><span>Next Week</span><span class="kbd">‚Üí</span></div>
              </div>
            </div>
          </div>

          <div class="flex gap-2 justify-end mt-6">
            <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
              Close
            </button>
          </div>
        </div>
      `);
    }

    function renderHome() {
      return `
        <div class="p-6 max-w-6xl mx-auto fade-in">
          <h1 style="color: ${CONFIG.text_color}; font-size: ${CONFIG.font_size * 2.5}px; font-family: ${CONFIG.font_family};"
              class="app-title mb-4 text-center font-bold">
            ${CONFIG.app_title}
          </h1>
          <p class="text-center mb-12" style="color: ${CONFIG.text_color}; opacity: 0.7; font-size: ${CONFIG.font_size * 1.1}px;">
            Plan meals, organize recipes, and shop smarter
          </p>

          <div class="grid md:grid-cols-3 gap-6">
            <button type="button" onclick="navigateTo('recipes')"
                    style="background: linear-gradient(135deg, ${CONFIG.surface_color} 0%, rgba(102, 126, 234, 0.1) 100%);"
                    class="p-8 rounded-2xl card-hover text-center glass">
              <div style="font-size: 4rem;" class="mb-4">üç≥</div>
              <h3 style="color: ${CONFIG.text_color}; font-size: ${CONFIG.font_size * 1.4}px; font-family: ${CONFIG.font_family};"
                  class="font-bold mb-3">
                ${CONFIG.recipes_label}
              </h3>
              <p style="color: ${CONFIG.text_color}; opacity: 0.7; font-size: ${CONFIG.font_size}px; font-family: ${CONFIG.font_family};">
                Browse and manage your recipe collection
              </p>
              <div class="mt-4 chip" style="background: rgba(102, 126, 234, 0.2); color: ${CONFIG.primary_action_color};">
                ${state.recipes.length} recipes
              </div>
            </button>

            <button type="button" onclick="navigateTo('weekly-plan')"
                    style="background: linear-gradient(135deg, ${CONFIG.surface_color} 0%, rgba(118, 75, 162, 0.1) 100%);"
                    class="p-8 rounded-2xl card-hover text-center glass">
              <div style="font-size: 4rem;" class="mb-4">üìÖ</div>
              <h3 style="color: ${CONFIG.text_color}; font-size: ${CONFIG.font_size * 1.4}px; font-family: ${CONFIG.font_family};"
                  class="font-bold mb-3">
                ${CONFIG.weekly_plan_label}
              </h3>
              <p style="color: ${CONFIG.text_color}; opacity: 0.7; font-size: ${CONFIG.font_size}px; font-family: ${CONFIG.font_family};">
                Plan your meals for the week
              </p>
              <div class="mt-4 chip" style="background: rgba(118, 75, 162, 0.2); color: ${CONFIG.secondary_action_color};">
                ${state.planData.length} plans
              </div>
            </button>

            <button type="button" onclick="navigateTo('grocery-list')"
                    style="background: linear-gradient(135deg, ${CONFIG.surface_color} 0%, rgba(245, 158, 11, 0.1) 100%);"
                    class="p-8 rounded-2xl card-hover text-center glass">
              <div style="font-size: 4rem;" class="mb-4">üõí</div>
              <h3 style="color: ${CONFIG.text_color}; font-size: ${CONFIG.font_size * 1.4}px; font-family: ${CONFIG.font_family};"
                  class="font-bold mb-3">
                ${CONFIG.grocery_list_label}
              </h3>
              <p style="color: ${CONFIG.text_color}; opacity: 0.7; font-size: ${CONFIG.font_size}px; font-family: ${CONFIG.font_family};">
                Generate shopping list from your plan
              </p>
              <div class="mt-4 chip" style="background: rgba(245, 158, 11, 0.2); color: ${CONFIG.accent_color};">
                Smart lists
              </div>
            </button>
          </div>
        </div>
      `;
    }

    function renderRecipes() {
      // Filter recipes based on draft status
      let list = state.showDrafts 
        ? state.recipes.filter(r => r.isDraft)
        : state.recipes.filter(r => !r.isDraft);

      // Apply other filters
      list = list.filter(r => {
        if (state.filterFavorites && !r.favorite) return false;
        if (state.filterSourceType !== 'all' && r.sourceType !== state.filterSourceType) return false;
        if (!state.showDrafts && state.selectedCategory !== 'All' && r.category !== state.selectedCategory) return false;
        if (state.searchTerm && !(r.title || '').toLowerCase().includes(state.searchTerm.toLowerCase())) return false;
        
        // Filter by ingredient group
        if (state.filterIngredientGroup !== 'all') {
          const recipeIngredients = recipeIngList(r);
          const hasIngredientInGroup = recipeIngredients.some(ing => ing.group === state.filterIngredientGroup);
          if (!hasIngredientInGroup) return false;
        }
        
        return true;
      });

      const draftCount = state.recipes.filter(r => r.isDraft).length;
      const publishedCount = state.recipes.filter(r => !r.isDraft).length;

      return `
                  <div class="p-6 max-w-7xl mx-auto fade-in">
          <!-- Header with gradient -->
          <div class="flex items-center justify-between mb-6 mobile-stack gap-3">
            <div>
              <h2 class="font-bold flex items-center gap-2" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 1.8}px;">
                <span>üìö</span> ${CONFIG.recipes_label}
              </h2>
              <p style="color:${CONFIG.text_color}; opacity:0.6; font-size:${CONFIG.font_size * 0.95}px; margin-top:4px;">
                ${publishedCount} published ‚Ä¢ ${draftCount} drafts
              </p>
            </div>
            <div class="flex gap-3">
              <button type="button" onclick="openNewDraft()"
                class="px-5 py-2.5 rounded-xl button-hover flex items-center gap-2"
                style="background:${CONFIG.secondary_action_color}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size}px; box-shadow: 0 2px 8px rgba(118, 75, 162, 0.3);">
                <span>üíæ</span> Save as Draft
              </button>
              <button type="button" onclick="openNewRecipe()"
                class="px-5 py-2.5 rounded-xl button-hover flex items-center gap-2"
                style="background:${CONFIG.primary_action_color}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size}px; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                <span>‚ûï</span> Add Recipe
              </button>
            </div>
          </div>

          <!-- Main Content Area -->
          <div class="grid lg:grid-cols-[280px_1fr] gap-6">
            <!-- Left Sidebar - Filters -->
            <div class="space-y-4">
              <!-- View Section -->
              <div class="rounded-lg p-4" style="background:${CONFIG.surface_color}; border: 1px solid rgba(255,255,255,0.08);">
                <h3 class="font-semibold mb-3 flex items-center gap-2" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 1.1}px;">
                  <span>üìÇ</span> View
                </h3>
                <div class="space-y-2">
                  <button type="button" 
                    onclick="state.showDrafts = false; state.selectedCategory = 'All'; render();"
                    class="w-full px-3 py-2 rounded text-left button-hover transition-all"
                    style="background:${!state.showDrafts ? CONFIG.primary_action_color : 'rgba(255,255,255,0.05)'}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size}px;">
                    üìö Published <span style="opacity:0.6;">(${publishedCount})</span>
                  </button>
                  <button type="button" 
                    onclick="state.showDrafts = true; state.selectedCategory = 'All'; render();"
                    class="w-full px-3 py-2 rounded text-left button-hover transition-all"
                    style="background:${state.showDrafts ? CONFIG.primary_action_color : 'rgba(255,255,255,0.05)'}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size}px;">
                    üìù Drafts <span style="opacity:0.6;">(${draftCount})</span>
                  </button>
                </div>
              </div>

              <!-- Filters Accordion -->
              <div class="rounded-lg overflow-hidden" style="background:${CONFIG.surface_color}; border: 1px solid rgba(255,255,255,0.08);">
                <div class="p-4 border-b" style="border-color: rgba(255,255,255,0.08);">
                  <h3 class="font-semibold flex items-center gap-2" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 1.1}px;">
                    <span>üîç</span> Filters
                  </h3>
                </div>

                <!-- Category Filter (only for published) -->
                ${!state.showDrafts ? `
                  <details open class="border-b" style="border-color: rgba(255,255,255,0.08);">
                    <summary class="p-3 cursor-pointer hover:bg-opacity-50 font-semibold" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.95}px; list-style: none;">
                      <span>‚ñ∏</span> Category
                    </summary>
                    <div class="px-3 pb-3 space-y-1">
                      <button type="button" onclick="state.selectedCategory='All'; render();"
                        class="w-full px-3 py-2 rounded text-left button-hover text-sm"
                        style="background:${state.selectedCategory === 'All' ? CONFIG.primary_action_color : 'transparent'}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.9}px;">
                        All Categories
                      </button>
                      ${MEAL_CATEGORIES.map(c => `
                        <button type="button" onclick="state.selectedCategory='${c}'; render();"
                          class="w-full px-3 py-2 rounded text-left button-hover text-sm"
                          style="background:${state.selectedCategory === c ? CONFIG.primary_action_color : 'transparent'}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.9}px;">
                          ${c}
                        </button>
                      `).join('')}
                    </div>
                  </details>
                ` : ''}

                <!-- Source Filter -->
                <details open class="border-b" style="border-color: rgba(255,255,255,0.08);">
                  <summary class="p-3 cursor-pointer hover:bg-opacity-50 font-semibold" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.95}px; list-style: none;">
                    <span>‚ñ∏</span> Source
                  </summary>
                  <div class="px-3 pb-3 space-y-1">
                    <button type="button" onclick="state.filterSourceType='all'; render();"
                      class="w-full px-3 py-2 rounded text-left button-hover text-sm"
                      style="background:${state.filterSourceType === 'all' ? CONFIG.primary_action_color : 'transparent'}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.9}px;">
                      üìã All Sources
                    </button>
                    <button type="button" onclick="state.filterSourceType='chefiq'; render();"
                      class="w-full px-3 py-2 rounded text-left button-hover text-sm"
                      style="background:${state.filterSourceType === 'chefiq' ? CONFIG.primary_action_color : 'transparent'}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.9}px;">
                      ü§ñ ChefIQ Guided
                    </button>
                    <button type="button" onclick="state.filterSourceType='user'; render();"
                      class="w-full px-3 py-2 rounded text-left button-hover text-sm"
                      style="background:${state.filterSourceType === 'user' ? CONFIG.primary_action_color : 'transparent'}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.9}px;">
                      üë§ User-Created
                    </button>
                  </div>
                </details>

                <!-- Ingredient Group Filter -->
                <details class="border-b" style="border-color: rgba(255,255,255,0.08);">
                  <summary class="p-3 cursor-pointer hover:bg-opacity-50 font-semibold" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.95}px; list-style: none;">
                    <span>‚ñ∏</span> Ingredient Type
                  </summary>
                  <div class="px-3 pb-3 space-y-1" style="max-height: 240px; overflow-y: auto;">
                    <button type="button" onclick="state.filterIngredientGroup='all'; render();"
                      class="w-full px-3 py-2 rounded text-left button-hover text-sm"
                      style="background:${state.filterIngredientGroup === 'all' ? CONFIG.primary_action_color : 'transparent'}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.9}px;">
                      üçΩÔ∏è All Ingredients
                    </button>
                    ${ING_GROUPS.map(group => `
                      <button type="button" onclick="state.filterIngredientGroup='${group}'; render();"
                        class="w-full px-3 py-2 rounded text-left button-hover text-sm"
                        style="background:${state.filterIngredientGroup === group ? CONFIG.primary_action_color : 'transparent'}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.85}px;">
                        ${group}
                      </button>
                    `).join('')}
                  </div>
                </details>

                <!-- Additional Filters -->
                <div class="p-3">
                  <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-opacity-50" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.9}px;">
                    <input type="checkbox" ${state.filterFavorites ? 'checked' : ''}
                      onchange="state.filterFavorites=this.checked; render();">
                    <span>‚≠ê</span> Favorites Only
                  </label>
                </div>
              </div>
            </div>

            <!-- Right Content Area - Recipes -->
            <div>
              <!-- Search Bar -->
              <div class="mb-4">
                <input placeholder="üîç Search recipes by name..."
                  class="w-full px-4 py-3 rounded border"
                  style="background:${CONFIG.surface_color}; color:${CONFIG.text_color}; border-color:${CONFIG.secondary_action_color}; font-size:${CONFIG.font_size}px;"
                  value="${esc(state.searchTerm)}"
                  oninput="state.searchTerm=this.value; render();"/>
              </div>

              <!-- Results -->
              ${list.length === 0 ? `
                <div class="p-12 rounded text-center" style="background:${CONFIG.surface_color}; color:${CONFIG.text_color};">
                  <div style="font-size:3rem; margin-bottom:1rem;">üì≠</div>
                  <div style="font-size:${CONFIG.font_size * 1.2}px; margin-bottom:0.5rem;">
                    ${state.showDrafts ? 'No drafts found' : 'No recipes found'}
                  </div>
                  <div style="opacity:0.7; font-size:${CONFIG.font_size * 0.9}px;">
                    ${state.searchTerm ? 'Try adjusting your search or filters' : state.showDrafts ? 'Start by saving a recipe as a draft' : 'Add your first recipe to get started'}
                  </div>
                </div>` : `
                <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-4">
                  ${list.map(r => {
                    const id = r.__backendId || r.id;
                    const img = recipeThumb(r);
                    const sourceIcon = r.sourceType === 'chefiq' ? 'ü§ñ' : 'üë§';
                    return `
                    <div class="rounded-lg overflow-hidden card-hover cursor-pointer"
                      onclick="openRecipeView('${id}')"
                      style="background:${CONFIG.surface_color}; border:1px solid rgba(255,255,255,0.08);">
                      
                      <!-- Image -->
                      ${img ? `
                        <div style="height:140px; overflow:hidden;">
                          <img src="${esc(img)}" style="width:100%; height:100%; object-fit:cover;" />
                        </div>
                      ` : `
                        <div style="height:140px; background:rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:center; font-size:3rem;">
                          üçΩÔ∏è
                        </div>
                      `}

                      <!-- Content -->
                      <div class="p-4">
                        <div class="flex items-start justify-between gap-2 mb-2">
                          <div class="flex-1">
                            <div class="font-semibold" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 1.05}px; line-height:1.3;">
                              ${esc(r.title)}
                            </div>
                            <div style="color:${CONFIG.text_color}; opacity:.65; font-size:${CONFIG.font_size * .85}px; margin-top:4px;">
                              ${sourceIcon} ${esc(r.category)}
                            </div>
                            ${r.isDraft ? `<div style="color:#f59e0b; font-size:${CONFIG.font_size * .8}px; font-weight:600; margin-top:4px;">üìù DRAFT</div>` : ''}
                          </div>
                          <button type="button" class="text-xl"
                            onclick="event.stopPropagation(); toggleFavorite('${id}')">
                            ${r.favorite ? '‚≠ê' : '‚òÜ'}
                          </button>
                        </div>

                        <div class="flex gap-2 mt-3">
                          ${r.isDraft ? `
                            <button type="button"
                              onclick="event.stopPropagation(); publishDraft('${id}')"
                              class="flex-1 px-2 py-1.5 rounded button-hover text-center"
                              style="background:#16a34a; color:white; font-size:${CONFIG.font_size * .85}px;">
                              Publish
                            </button>
                          ` : ''}
                          <button type="button"
                            onclick="event.stopPropagation(); openEditRecipe('${id}')"
                            class="flex-1 px-2 py-1.5 rounded button-hover text-center"
                            style="background:${CONFIG.primary_action_color}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * .85}px;">
                            Edit
                          </button>
                          <button type="button"
                            onclick="event.stopPropagation(); if(confirm('Delete this recipe?')) deleteRecipe(state.recipes.find(x=>(x.__backendId||x.id)==='${id}'))"
                            class="flex-1 px-2 py-1.5 rounded button-hover text-center"
                            style="background:#dc2626; color:white; font-size:${CONFIG.font_size * .85}px;">
                            Delete
                          </button>
                        </div>
                      </div>
                    </div>`;
                  }).join('')}
                </div>
              `}
            </div>
          </div>
        </div>`;
    }

    function renderIngredientGrid() {
      if (!state.recipeForm) return '';

      return `
        <div class="mt-6">
          <div class="flex items-center justify-between mb-2">
            <label class="font-semibold" style="color:${CONFIG.text_color};">Ingredients</label>
            <div class="flex gap-2">
              <button type="button" onclick="showBulkImportModal()"
                class="px-3 py-2 rounded button-hover"
                style="background:${CONFIG.secondary_action_color}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.9}px;">
                üìã Bulk Import
              </button>
              <button type="button" onclick="addIngRow()"
                class="px-3 py-2 rounded button-hover"
                style="background:${CONFIG.primary_action_color}; color:${CONFIG.text_color};">+ Add</button>
            </div>
          </div>

          <div class="rounded overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
            <div class="grid" style="grid-template-columns:110px 120px 1fr 160px 56px; background:rgba(255,255,255,0.04);">
              <div class="p-3 font-semibold" style="color:${CONFIG.text_color}; opacity:.85;">Amt</div>
              <div class="p-3 font-semibold" style="color:${CONFIG.text_color}; opacity:.85;">Unit</div>
              <div class="p-3 font-semibold" style="color:${CONFIG.text_color}; opacity:.85;">Ingredient</div>
              <div class="p-3 font-semibold" style="color:${CONFIG.text_color}; opacity:.85;">Group</div>
              <div class="p-3"></div>
            </div>

            ${(state.recipeForm.ingredientsRows || []).map((row, i) => `
              <div class="grid items-center" style="grid-template-columns:110px 120px 1fr 160px 56px; border-top:1px solid rgba(255,255,255,0.06);">
                <div class="p-2">
                  <input class="w-full px-3 py-2 rounded border"
                    style="background:rgba(0,0,0,0.16); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.10);"
                    value="${esc(row.qty || '')}"
                    oninput="setIng(${i},'qty',this.value)" />
                </div>

                <div class="p-2">
                  <input class="w-full px-3 py-2 rounded border" placeholder="e.g. lb"
                    style="background:rgba(0,0,0,0.16); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.10);"
                    value="${esc(row.unit || '')}"
                    oninput="setIng(${i},'unit',this.value)" />
                </div>

                <div class="p-2">
                  <input class="w-full px-3 py-2 rounded border" placeholder="e.g. Chicken breast"
                    style="background:rgba(0,0,0,0.16); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.10);"
                    value="${esc(row.name || '')}"
                    oninput="setIng(${i},'name',this.value)" />
                </div>

                <div class="p-2">
                  <select class="w-full px-3 py-2 rounded border"
                    style="background:rgba(0,0,0,0.16); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.10);"
                    onchange="setIng(${i},'group',this.value)">
                    ${ING_GROUPS.map(g => `<option value="${g}" ${(row.group || 'Produce') === g ? 'selected' : ''}>${g}</option>`).join('')}
                  </select>
                </div>

                <div class="p-2 flex justify-center">
                  <button type="button" onclick="delIngRow(${i})"
                    class="w-10 h-10 rounded button-hover"
                    style="background:rgba(220,38,38,0.75); color:white;">√ó</button>
                </div>
              </div>
            `).join('')}
          </div>
        </div>`;
    }

    function renderRecipeEdit() {
      if (!state.recipeForm) return '';

      return `
        <div class="p-6 max-w-5xl mx-auto">
          <div class="flex items-center justify-between mb-6 mobile-stack gap-3">
            <h2 class="font-bold" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 1.6}px;">
              ${state.recipeForm.id ? 'Edit Recipe' : (state.recipeForm.isDraft ? 'New Draft' : 'New Recipe')}
            </h2>
            <div class="flex gap-2">
              <button type="button" onclick="closeRecipeEditor()"
                class="px-4 py-2 rounded button-hover"
                style="background:${CONFIG.secondary_action_color}; color:${CONFIG.text_color};">Cancel</button>
              <button type="button" onclick="saveRecipeForm()"
                class="px-4 py-2 rounded button-hover"
                style="background:${CONFIG.primary_action_color}; color:${CONFIG.text_color};">
                ${state.recipeForm.isDraft ? 'Save Draft' : 'Save Recipe'}
              </button>
            </div>
          </div>

          <div class="rounded p-6" style="background:${CONFIG.surface_color};">
            <label class="block mb-2 font-semibold" style="color:${CONFIG.text_color};">Recipe Title *</label>
            <input class="w-full px-4 py-3 rounded border"
              style="background:rgba(0,0,0,0.18); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.12);"
              value="${esc(state.recipeForm.title || '')}"
              oninput="setRecipeField('title', this.value)" />

            <div class="grid md:grid-cols-2 gap-4 mt-5">
              <div>
                <label class="block mb-2 font-semibold" style="color:${CONFIG.text_color};">Category *</label>
                <select class="w-full px-4 py-3 rounded border"
                  style="background:rgba(0,0,0,0.18); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.12);"
                  onchange="setRecipeField('category', this.value)">
                  ${MEAL_CATEGORIES.map(c => `
                    <option value="${c}" ${state.recipeForm.category === c ? 'selected' : ''}>${c}</option>
                  `).join('')}
                </select>
              </div>

              <div>
                <label class="block mb-2 font-semibold" style="color:${CONFIG.text_color};">Source Type</label>
                <select class="w-full px-4 py-3 rounded border"
                  style="background:rgba(0,0,0,0.18); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.12);"
                  onchange="setRecipeField('sourceType', this.value)">
                  <option value="user" ${(state.recipeForm.sourceType || 'user') === 'user' ? 'selected' : ''}>User-Created</option>
                  <option value="chefiq" ${state.recipeForm.sourceType === 'chefiq' ? 'selected' : ''}>ChefIQ Guided</option>
                </select>
              </div>
            </div>

            <div class="mt-5">
              <label class="block mb-2 font-semibold" style="color:${CONFIG.text_color};">Recipe URL *</label>
              <input class="w-full px-4 py-3 rounded border" placeholder="https://..."
                style="background:rgba(0,0,0,0.18); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.12);"
                value="${esc(state.recipeForm.recipe_url || '')}"
                oninput="setRecipeField('recipe_url', this.value)" />
            </div>

            <div class="mt-5">
              <label class="block mb-2 font-semibold" style="color:${CONFIG.text_color};">Image</label>
              
              <!-- Tab Selection -->
              <div class="flex gap-2 mb-3">
                <button type="button" 
                  onclick="document.getElementById('imageUrlTab').style.display='block'; document.getElementById('imageUploadTab').style.display='none'; this.style.background='${CONFIG.primary_action_color}'; this.nextElementSibling.style.background='rgba(255,255,255,0.05)';"
                  class="px-3 py-2 rounded button-hover"
                  style="background:${CONFIG.primary_action_color}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.9}px;">
                  üîó Image URL
                </button>
                <button type="button"
                  onclick="document.getElementById('imageUrlTab').style.display='none'; document.getElementById('imageUploadTab').style.display='block'; this.style.background='${CONFIG.primary_action_color}'; this.previousElementSibling.style.background='rgba(255,255,255,0.05)';"
                  class="px-3 py-2 rounded button-hover"
                  style="background:rgba(255,255,255,0.05); color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.9}px;">
                  üì§ Upload Image
                </button>
              </div>

              <!-- Image URL Tab -->
              <div id="imageUrlTab">
                <input class="w-full px-4 py-3 rounded border" placeholder="Paste image URL here"
                  style="background:rgba(0,0,0,0.18); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.12);"
                  value="${esc(state.recipeForm.image_url || '')}"
                  oninput="setRecipeField('image_url', this.value)" />
                <p style="color:${CONFIG.text_color}; opacity:0.6; font-size:${CONFIG.font_size * 0.85}px; margin-top:8px;">
                  Enter a URL to an image hosted online
                </p>
              </div>

              <!-- Image Upload Tab -->
              <div id="imageUploadTab" style="display:none;">
                <div class="rounded border-2 border-dashed p-6 text-center"
                  style="border-color:rgba(255,255,255,0.2); background:rgba(0,0,0,0.1);">
                  <input type="file" id="imageUploadInput" accept="image/*" 
                    onchange="handleImageUpload(event)"
                    class="hidden" />
                  <label for="imageUploadInput" class="cursor-pointer">
                    <div style="font-size:3rem; margin-bottom:0.5rem;">üì∏</div>
                    <div style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size}px; margin-bottom:0.5rem;">
                      Click to upload or drag image here
                    </div>
                    <div style="color:${CONFIG.text_color}; opacity:0.6; font-size:${CONFIG.font_size * 0.85}px;">
                      Supports JPG, PNG, GIF (max 5MB)
                    </div>
                  </label>
                </div>
              </div>

              <!-- Image Preview -->
              ${state.recipeForm.image_url ? `
                <div class="mt-4 rounded overflow-hidden relative" style="border:1px solid rgba(255,255,255,0.08);">
                  <img src="${state.recipeForm.image_url}" 
                       alt="Recipe preview"
                       onerror="this.parentElement.querySelector('.error-msg').style.display='block'; this.style.display='none';"
                       style="width:100%; max-height:260px; object-fit:cover;" />
                  <div class="error-msg p-4 text-center" style="display:none; color:#dc2626; background:rgba(220,38,38,0.1);">
                    ‚ö†Ô∏è Image failed to load. The URL might be invalid or blocked.
                  </div>
                  <button type="button" onclick="removeImage()"
                    class="absolute top-2 right-2 px-3 py-1.5 rounded button-hover"
                    style="background:rgba(220,38,38,0.9); color:white; font-size:${CONFIG.font_size * 0.85}px;">
                    ‚úï Remove
                  </button>
                </div>
                <div class="mt-2 p-2 rounded" style="background:rgba(255,255,255,0.05); color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 0.85}px; word-break:break-all;">
                  <strong>Current URL:</strong> ${state.recipeForm.image_url}
                </div>` : ''}
            </div>

            ${renderIngredientGrid()}

            <div class="mt-6">
              <label class="block mb-2 font-semibold" style="color:${CONFIG.text_color};">Tags (optional)</label>
              <input class="w-full px-4 py-3 rounded border" placeholder="e.g. Mediterranean, High Protein"
                style="background:rgba(0,0,0,0.18); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.12);"
                value="${esc(state.recipeForm.tags || '')}"
                oninput="setRecipeField('tags', this.value)" />
            </div>

            <div class="mt-6">
              <label class="block mb-2 font-semibold" style="color:${CONFIG.text_color};">
                Step-by-step Instructions (optional)
                <span style="opacity:0.7; font-weight:normal; font-size:${CONFIG.font_size * 0.85}px;"> ‚Äî Enter each step on a new line</span>
              </label>
              <textarea class="w-full px-4 py-3 rounded border"
                style="background:rgba(0,0,0,0.18); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.12); min-height:180px;"
                placeholder="Step 1: Preheat oven to 350¬∞F
Step 2: Mix dry ingredients
Step 3: Add wet ingredients..."
                oninput="setRecipeField('instructions', this.value)">${state.recipeForm.instructions || ''}</textarea>
            </div>

            <div class="mt-6">
              <label class="block mb-2 font-semibold" style="color:${CONFIG.text_color};">Notes (optional)</label>
              <textarea class="w-full px-4 py-3 rounded border"
                style="background:rgba(0,0,0,0.18); color:${CONFIG.text_color}; border-color:rgba(255,255,255,0.12); min-height:120px;"
                oninput="setRecipeField('notes', this.value)">${state.recipeForm.notes || ''}</textarea>
            </div>

            <div class="mt-6">
              <label class="flex items-center gap-2" style="color:${CONFIG.text_color};">
                <input type="checkbox" ${state.recipeForm.isDraft ? 'checked' : ''}
                  onchange="setRecipeField('isDraft', this.checked)">
                Save as Draft (won't appear in meal planning)
              </label>
            </div>
          </div>
        </div>`;
    }

    function renderRecipeView() {
      const r = getRecipeById(state.selectedRecipeViewId);
      if (!r) return `<div class="p-6" style="color:${CONFIG.text_color};">Recipe not found.</div>`;

      const img = recipeThumb(r);
      const url = (r.recipe_url || '').trim();
      const tags = (r.tags || '').trim();
      const notes = (r.notes || '').trim();
      const instructions = (r.instructions || '').trim();
      const sourceLabel = r.sourceType === 'chefiq' ? 'ü§ñ ChefIQ Guided' : 'üë§ User-Created';

      const rows = Array.isArray(r.ingredientsRows) ? r.ingredientsRows : [];
      const grouped = {};
      rows.forEach(x => {
        const g = x.group || 'Other';
        if (!grouped[g]) grouped[g] = [];
        grouped[g].push(x);
      });
      const groupOrder = Object.keys(grouped);

      // Parse instructions into steps
      const instructionSteps = instructions ? instructions.split('\n').filter(s => s.trim()) : [];

      // Debug: Log image URL
      console.log('Recipe image URL:', img);

      return `
                  <div class="p-6 max-w-5xl mx-auto">
          <div class="flex items-center justify-between mb-4 mobile-stack gap-3">
            <button type="button" onclick="state.currentView='${state.viewingFromPlan ? 'weekly-plan' : 'recipes'}'; state.viewingFromPlan=null; render();"
              class="px-4 py-2 rounded button-hover"
              style="background:${CONFIG.secondary_action_color}; color:${CONFIG.text_color};">‚Üê Back</button>

            <div class="flex gap-2 flex-wrap">
              ${state.viewingFromPlan ? `
                <button type="button" onclick="openRecipePicker('${state.viewingFromPlan.date}', '${state.viewingFromPlan.meal}')"
                  class="px-4 py-2 rounded-xl button-hover"
                  style="background:${CONFIG.primary_action_color}; color:${CONFIG.text_color};">
                  üîÑ Change Recipe
                </button>
                <button type="button" onclick="if(confirm('Remove this meal from your plan?')) { removeMealFromPlan('${state.viewingFromPlan.date}', '${state.viewingFromPlan.meal}'); state.currentView='weekly-plan'; state.viewingFromPlan=null; }"
                  class="px-4 py-2 rounded-xl button-hover"
                  style="background:#dc2626; color:white;">
                  üóëÔ∏è Remove from Plan
                </button>
              ` : ''}
              ${r.isDraft ? `
                <button type="button" onclick="publishDraft('${r.__backendId || r.id}')"
                  class="px-4 py-2 rounded button-hover"
                  style="background:#16a34a; color:white;">Publish</button>
              ` : ''}
              <button type="button" onclick="openEditRecipe('${r.__backendId || r.id}')"
                class="px-4 py-2 rounded button-hover"
                style="background:${CONFIG.primary_action_color}; color:${CONFIG.text_color};">Edit</button>
            </div>
          </div>

          <div class="rounded p-5" style="background:${CONFIG.surface_color};">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-bold" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 1.7}px;">
                  ${esc(r.title)}
                </div>
                <div style="color:${CONFIG.text_color}; opacity:.7;">
                  ${esc(r.category)} ‚Ä¢ ${sourceLabel}
                </div>
                ${r.isDraft ? `<div style="color:#f59e0b; font-weight:600; margin-top:8px;">üìù DRAFT - Not available for meal planning</div>` : ''}
              </div>
              <button type="button" onclick="toggleFavorite('${r.__backendId || r.id}')" class="text-2xl">
                ${r.favorite ? '‚≠ê' : '‚òÜ'}
              </button>
            </div>

            ${img ? `
              <div class="mt-4 rounded overflow-hidden" style="border:1px solid rgba(255,255,255,0.08);">
                <img src="${img}" 
                     alt="${esc(r.title)}"
                     onerror="console.error('Image failed to load:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';"
                     onload="console.log('Image loaded successfully:', this.src);"
                     style="width:100%; max-height:260px; object-fit:cover; display:block;" />
                <div style="display:none; padding:20px; text-align:center; color:#dc2626; background:rgba(220,38,38,0.1);">
                  ‚ö†Ô∏è Image failed to load<br>
                  <small style="font-size:12px; opacity:0.8;">${img}</small>
                </div>
              </div>
            ` : ''}

            ${url ? `<div class="mt-4">
              <a href="${esc(url)}" target="_blank" rel="noopener noreferrer"
                style="color:${CONFIG.text_color}; text-decoration:underline; opacity:.9;">
                Open recipe link ‚Üí
              </a>
            </div>` : ''}

            ${tags ? `<div class="mt-4" style="color:${CONFIG.text_color}; opacity:.85;">
              <span class="font-semibold">Tags:</span> ${esc(tags)}
            </div>` : ''}

            ${groupOrder.length ? `
              <div class="mt-6">
                <div class="font-semibold mb-2" style="color:${CONFIG.text_color};">Ingredients</div>
                ${groupOrder.map(g => `
                  <div class="mb-4">
                    <div class="font-semibold" style="color:${CONFIG.text_color}; opacity:.8;">${esc(g)}</div>
                    <ul class="mt-2" style="color:${CONFIG.text_color}; opacity:.9;">
                      ${grouped[g].map(x => `<li>‚Ä¢ ${esc((x.qty || '').trim())} ${esc((x.unit || '').trim())} ${esc((x.name || '').trim())}</li>`).join('')}
                    </ul>
                  </div>
                `).join('')}
              </div>` : ''}

            <div class="mt-6">
              <div class="font-semibold mb-2" style="color:${CONFIG.text_color};">Step-by-step Instructions</div>
              ${instructionSteps.length ? `
                <ol class="space-y-3" style="color:${CONFIG.text_color}; opacity:.9; list-style: none; counter-reset: step-counter;">
                  ${instructionSteps.map((step, idx) => `
                    <li style="counter-increment: step-counter; padding-left: 2.5rem; position: relative;">
                      <span style="position: absolute; left: 0; font-weight: 600; color: ${CONFIG.primary_action_color};">
                        Step ${idx + 1}:
                      </span>
                      ${esc(step)}
                    </li>
                  `).join('')}
                </ol>` : `
                <div style="color:${CONFIG.text_color}; opacity:.6;">
                  No instructions saved yet. Add them in Edit.
                </div>`}
            </div>

            ${notes ? `
              <div class="mt-6">
                <div class="font-semibold mb-2" style="color:${CONFIG.text_color};">Notes</div>
                <div class="rounded p-4" style="background:rgba(255,255,255,0.03); color:${CONFIG.text_color}; white-space:pre-wrap;">
                  ${esc(notes)}
                </div>
              </div>` : ''}
          </div>
        </div>`;
    }

    function renderWeeklyPlan() {
      const weekDates = getWeekDates(state.currentWeekStartDate);
      const meals = ['Breakfast', 'Lunch', 'Dinner'];

      return `
        <div class="p-6 max-w-7xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 class="font-bold" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 1.5}px;">
              ${CONFIG.weekly_plan_label}
            </h2>
            <div class="flex gap-2">
              <button type="button" onclick="changeWeek(-1)" class="px-4 py-2 rounded button-hover"
                style="background:${CONFIG.secondary_action_color}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size}px;">‚Üê Previous</button>
              <button type="button" onclick="changeWeek(1)" class="px-4 py-2 rounded button-hover"
                style="background:${CONFIG.secondary_action_color}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size}px;">Next ‚Üí</button>
            </div>
          </div>

          <div class="grid gap-4">
            ${weekDates.map(date => {
              const plan = state.planData.find(p => p.date === date);
              return `
              <div class="rounded p-4" style="background:${CONFIG.surface_color};">
                <div class="font-semibold mb-3" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 1.1}px;">
                  ${formatDateDisplay(date)}
                </div>
                <div class="grid gap-2">
                  ${meals.map(meal => {
                    const key = meal.toLowerCase();
                    const rid = plan ? plan[key] : null;
                    const r = rid ? getRecipeById(rid) : null;
                    const img = r ? recipeThumb(r) : '';
                    const url = r ? (r.recipe_url || '').trim() : '';
                    const linkStart = url ? `<a href="${esc(url)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();" class="flex items-center gap-3">` : `<div class="flex items-center gap-3">`;
                    const linkEnd = url ? `</a>` : `</div>`;

                    return `
                    <div class="flex items-center justify-between p-3 rounded" style="background:rgba(255,255,255,0.03);">

                      <div class="flex items-center gap-3 flex-1">
  ${img ? `<img src="${esc(img)}" style="width:60px;height:60px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,0.08);" />` :
     `<div style="width:60px;height:60px;border-radius:10px;background:rgba(255,255,255,0.06);"></div>`}

  
  <div class="flex-1">
    <div style="color:${CONFIG.text_color}; opacity:.7; font-size:${CONFIG.font_size * .85}px;">${meal}</div>
    <div style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size}px;">
      ${r ? esc(r.title) : '<span style="opacity:.5;">No meal planned</span>'}
    </div>
  </div>
</div>

                      <div class="flex gap-2">
                        ${r ? `
                          <button type="button" onclick="event.stopPropagation(); openRecipeView('${r.__backendId || r.id}')"
                            class="px-3 py-1 rounded button-hover"
                            style="background:${CONFIG.secondary_action_color}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size * .85}px;">
                            View
                          </button>
                          <button type="button" onclick="event.stopPropagation(); removeMealFromPlan('${date}','${meal}')"
                            class="px-3 py-1 rounded button-hover"
                            style="background:#dc2626;color:white;font-size:${CONFIG.font_size * .85}px;">
                            Remove
                          </button>` : ''}

                        <button type="button" onclick="event.stopPropagation(); openRecipePicker('${date}','${meal}')"
                          class="px-3 py-1 rounded button-hover"
                          style="background:${CONFIG.primary_action_color};color:${CONFIG.text_color};font-size:${CONFIG.font_size * .85}px;">
                          ${r ? 'Change' : 'Add'}
                        </button>
                      </div>
                    </div>`;
                  }).join('')}
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>`;
    }

    function renderRecipePicker() {
      // Only show published recipes in picker


    const filteredRecipes = state.recipes.filter(r => {
  if (r.isDraft) return false; // Exclude drafts
  if (state.filterFavorites && !r.favorite) return false;
  if (state.filterUserCreated && r.sourceType !== 'user') return false; // ‚Üê ADD THIS LINE
  if (state.searchTerm && !r.title.toLowerCase().includes(state.searchTerm.toLowerCase())) return false;
  if (state.selectedCategory === 'All') return true;
  return r.category === state.selectedCategory;
});

      return `
        <div class="p-6 max-w-6xl mx-auto">
          <div class="flex items-center justify-between mb-6 mobile-stack gap-3">
            <h2 style="color: ${CONFIG.text_color}; font-size: ${CONFIG.font_size * 1.5}px; font-family: ${CONFIG.font_family}, sans-serif;" class="font-bold">
              Select Recipe for ${formatDateDisplay(state.selectedDayForRecipe)} - ${state.selectedMealForRecipe}
            </h2>
            <button type="button" onclick="state.currentView='weekly-plan'; state.selectedDayForRecipe=null; state.selectedMealForRecipe=null; render();"
                    style="background: ${CONFIG.secondary_action_color}; color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
                    class="px-4 py-2 rounded button-hover">
              Cancel
            </button>
          </div>

          <div class="mb-4 flex gap-4 mobile-stack">
  <input type="text" placeholder="Search recipes..."
         style="background: ${CONFIG.surface_color}; color: ${CONFIG.text_color}; border-color: ${CONFIG.secondary_action_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
         class="flex-1 px-4 py-2 rounded border mobile-full"
         value="${state.searchTerm}"
         oninput="state.searchTerm = this.value; render();">

  <label style="color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;" class="flex items-center gap-2 whitespace-nowrap">
    <input type="checkbox" ${state.filterFavorites ? 'checked' : ''}
           onchange="state.filterFavorites = this.checked; render();">
    ‚≠ê Favorites Only
  </label>

  <label style="color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;" class="flex items-center gap-2 whitespace-nowrap">
    <input type="checkbox" ${state.filterUserCreated ? 'checked' : ''}
           onchange="state.filterUserCreated = this.checked; render();">
    üë§ User-Created Only
  </label>
</div>

          <div class="flex gap-2 mb-6 flex-wrap">
  <button type="button" onclick="state.selectedCategory='All'; render();"
          style="background: ${state.selectedCategory === 'All' ? CONFIG.primary_action_color : CONFIG.secondary_action_color};
                 color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
          class="px-4 py-2 rounded button-hover">
    All
  </button>
  ${MEAL_CATEGORIES.map(cat => `
    <button type="button" onclick="state.selectedCategory='${cat}'; render();"
            style="background: ${state.selectedCategory === cat ? CONFIG.primary_action_color : CONFIG.secondary_action_color};
                   color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
            class="px-4 py-2 rounded button-hover">
      ${cat}
    </button>
  `).join('')}
</div>


         <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
  ${filteredRecipes.length === 0 ? `
    <div style="background: ${CONFIG.surface_color}; color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
         class="p-8 rounded text-center col-span-full">
      No recipes found
    </div>
  ` : filteredRecipes.map(recipe => {
  const sourceLabel = recipe.sourceType === 'chefiq' ? 'ü§ñ' : 'üë§';
  const img = recipeThumb(recipe);
  return `

<button type="button"
        onclick="handleRecipePickerSelect('${recipe.__backendId || recipe.id}')"
        style="background: ${CONFIG.surface_color}; color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
        class="p-4 rounded card-hover text-left w-full flex flex-col gap-3">
  ${img ? `
    <img src="${esc(img)}" 
         alt="${esc(recipe.title)}"
         style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);"
         onerror="this.style.display='none';" />
  ` : `
    <div style="width: 100%; height: 150px; background: rgba(255,255,255,0.03); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3rem;">üçΩÔ∏è</div>
  `}
  <div class="flex items-center gap-2 flex-wrap">
    ${recipe.favorite ? '<span style="font-size: 1rem;">‚≠ê</span>' : ''}
    <span style="font-size: 1rem;">${sourceLabel}</span>
    <div style="opacity: 0.6; font-size: ${CONFIG.font_size * 0.8}px;">${recipe.category}</div>
  </div>
  <div class="font-semibold" style="font-size: ${CONFIG.font_size * 1.05}px; line-height: 1.3;">${recipe.title}</div>
  <div style="color: ${CONFIG.primary_action_color}; font-size: ${CONFIG.font_size * 0.9}px; text-align: center; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.08);">
    Select ‚Üí
  </div>
</button>
  
`}).join('')}



           
          </div>
        </div>
      `;
    }

    function renderGroceryIngredients() {
      const r = getRecipeById(state.selectedGroceryRecipeId);
      if (!r) return `<div class="p-6">Recipe not found</div>`;

      const list = recipeIngList(r);
      const selId = `mealSel_${state.selectedGroceryDate}_${state.selectedGroceryMeal}`;
      const sel = state.mealSelections.find(s => s.id === selId);

      let keys = [];
      try {
        keys = sel ? JSON.parse(sel.includedIngredientKeys || '[]') : list.map(x => normalizeIngredient(x.name));
      } catch (e) {
        keys = list.map(x => normalizeIngredient(x.name));
      }

      return `
        <div class="p-6 max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="font-bold" style="color:${CONFIG.text_color}; font-size:${CONFIG.font_size * 1.5}px;">Choose Ingredients</h2>
              <p style="color:${CONFIG.text_color}; opacity:.7; font-size:${CONFIG.font_size * .9}px;">
                ${esc(r.title)} ‚Ä¢ ${formatDateDisplay(state.selectedGroceryDate)} ${esc(state.selectedGroceryMeal)}
              </p>
            </div>
            <button type="button" onclick="state.currentView='grocery-list'; render();"
              class="px-4 py-2 rounded button-hover"
              style="background:${CONFIG.primary_action_color}; color:${CONFIG.text_color}; font-size:${CONFIG.font_size}px;">
              Done
            </button>
          </div>

          <div class="rounded p-4" style="background:${CONFIG.surface_color};">
            ${list.length ? list.map(ing => {
              const k = normalizeIngredient(ing.name);
              const checked = keys.includes(k);
              return `
              <label class="flex items-center justify-between gap-3 p-3 rounded mb-2"
                style="background:rgba(255,255,255,0.04); color:${CONFIG.text_color}; font-size:${CONFIG.font_size}px;">
                <div class="flex items-center gap-3">
                  <input type="checkbox" ${checked ? 'checked' : ''}
                    onchange="toggleMealIngredient('${k}')" />
                  <span>${esc(ing.qty)}${ing.unit ? ' ' + esc(ing.unit) : ''} ${esc(ing.name)}</span>
                </div>
              </label>`;
            }).join('') : `<div style="color:${CONFIG.text_color};opacity:.7;">No ingredients on this recipe yet.</div>`}
          </div>
        </div>`;
    }

    function renderGrocerySelectMeals() {
      const plannedMeals = getPlannedMealsForWeek(state.currentWeekStartDate);

      return `
        <div class="p-6 max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 style="color: ${CONFIG.text_color}; font-size: ${CONFIG.font_size * 1.5}px; font-family: ${CONFIG.font_family}, sans-serif;" class="font-bold">
              Select Meals for Grocery List
            </h2>
            <button type="button" onclick="state.currentView='grocery-list'; render();"
                    style="background: ${CONFIG.primary_action_color}; color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
                    class="px-4 py-2 rounded button-hover">
              Done
            </button>
          </div>

          ${plannedMeals.length === 0 ? `
            <div style="background: ${CONFIG.surface_color}; color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
                 class="p-8 rounded text-center">
              No meals planned for this week
            </div>
          ` : `
            <div class="grid gap-3">
              ${plannedMeals.map(meal => `
                <div style="background: ${CONFIG.surface_color};" class="p-4 rounded card-hover flex items-center justify-between">
                  <div>
                    <div style="color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size * 1.125}px;" class="font-semibold">
                      ${meal.recipeTitle}
                    </div>
                    <div style="color: ${CONFIG.text_color}; opacity: 0.7; font-size: ${CONFIG.font_size * 0.875}px; font-family: ${CONFIG.font_family}, sans-serif;">
                      ${formatDateDisplay(meal.date)} - ${meal.meal}
                    </div>
                  </div>
                  <button type="button" onclick="openGroceryIngredientPicker('${meal.date}', '${meal.meal}', '${meal.recipeId}')"
                          style="background: ${CONFIG.primary_action_color}; color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
                          class="px-4 py-2 rounded button-hover">
                    Choose Ingredients
                  </button>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      `;
    }

    function renderGroceryList() {
      const groceryList = getGroceryList();
      const unchecked = groceryList.filter(item => !item.checked);
      const checked = groceryList.filter(item => item.checked);

      return `
        <div class="p-6 max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-6">
            <h2 style="color: ${CONFIG.text_color}; font-size: ${CONFIG.font_size * 1.5}px; font-family: ${CONFIG.font_family}, sans-serif;" class="font-bold">
              ${CONFIG.grocery_list_label}
            </h2>
            <button type="button" onclick="state.currentView='grocery-select-meals'; render();"
                    style="background: ${CONFIG.primary_action_color}; color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
                    class="px-4 py-2 rounded button-hover">
              Select Meals
            </button>
          </div>

          ${groceryList.length === 0 ? `
            <div style="background: ${CONFIG.surface_color}; color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
                 class="p-8 rounded text-center">
              No ingredients selected. Click "Select Meals" to add items to your grocery list.
            </div>
          ` : `
            <div style="background: ${CONFIG.surface_color};" class="rounded p-4">
              ${unchecked.length > 0 ? `
                <div class="mb-4">
                  <h3 style="color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size * 1.125}px;" class="font-semibold mb-2">
                    To Buy
                  </h3>
                  ${unchecked.map(item => `
                    <label style="color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
                           class="flex items-center gap-3 p-3 rounded hover:bg-opacity-50 cursor-pointer">
                      <input type="checkbox" onchange="toggleGroceryItem('${normalizeIngredient(item.name)}')">
                      <span>${item.quantity} ${item.unit} ${item.name}</span>
                    </label>
                  `).join('')}
                </div>
              ` : ''}

              ${checked.length > 0 ? `
                <div>
                  <h3 style="color: ${CONFIG.text_color}; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size * 1.125}px;" class="font-semibold mb-2">
                    Checked Off
                  </h3>
                  ${checked.map(item => `
                    <label style="color: ${CONFIG.text_color}; opacity: 0.5; font-family: ${CONFIG.font_family}, sans-serif; font-size: ${CONFIG.font_size}px;"
                           class="flex items-center gap-3 p-3 rounded hover:bg-opacity-50 cursor-pointer line-through">
                      <input type="checkbox" checked onchange="toggleGroceryItem('${normalizeIngredient(item.name)}')">
                      <span>${item.quantity} ${item.unit} ${item.name}</span>
                    </label>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          `}
        </div>
      `;
    }

    // ===== MAIN RENDER =====
    function render() {
      const app = document.getElementById('app');
      if (!app) return;

      let content = '';
      switch (state.currentView) {
        case 'home':
          content = renderHome();
          break;
        case 'recipes':
          content = renderRecipes();
          break;
        case 'recipe-edit':
          content = renderRecipeEdit();
          break;
        case 'recipe-view':
          content = renderRecipeView();
          break;
        case 'weekly-plan':
          content = renderWeeklyPlan();
          break;
        case 'recipe-picker':
          content = renderRecipePicker();
          break;
        case 'grocery-list':
          content = renderGroceryList();
          break;
        case 'grocery-select-meals':
          content = renderGrocerySelectMeals();
          break;
        case 'grocery-ingredients':
          content = renderGroceryIngredients();
          break;
        default:
          content = renderHome();
      }

      app.innerHTML = `
        <div style="background: ${CONFIG.background_color}; min-height: 100vh;">
          ${renderNav()}
          ${content}
        </div>
      `;
    }

    // ===== INITIALIZATION =====
    async function init() {
      await storage.init(dataHandler);
      setupKeyboardShortcuts();
      render();
      
      // Show welcome message on first load
      if (state.recipes.length === 0) {
        setTimeout(() => {
          showToast('Welcome! Press ‚öôÔ∏è to view keyboard shortcuts', 'info');
        }, 500);
      }
    }

    init();
  </script>
</body>
</html>
